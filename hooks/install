#!/usr/bin/python
import setup
setup.pre_install()

from charmhelpers.core.hookenv import log
from charmhelpers import fetch
from path import path
from utils import home
from utils import shell

import logging

pkgs = ['git-core',
        'build-essential',
        'libssl-dev',
        'libsqlite3-dev',
        'openssl',
        'libpq-dev',
        'libmysqlclient-dev',
        'ruby1.9.3',
        'bundler']

here = path(__file__).parent.abspath()
charm = here.parent

logger = logging.getLogger(__name__)

templates = charm / 'templates'

def install_ruby_repo(repo, dest, overwrites=None):
    cmd = 'git clone %s %s' % (repo, dest)
    if dest.exists():
        with dest:
            shell('git pull --rebase')
    else:
        shell(cmd)

    if not overwrites is None:
        for fp in overwrites:
            fp.copy(dest / fp.basename())

    with dest:
        shell('chown ubuntu:ubuntu -R ./')
        shell('sudo -u ubuntu -s bundle install')


repo = "https://github.com/owaism/admin-ui.git"
# 'https://github.com/cloudfoundry-incubator/admin-ui.git'


def install(pkgs=pkgs):
    log('Installing cf-webadmin')
    fetch.apt_install(fetch.filter_installed_packages(pkgs))

    shell('gem install bundler --no-rdoc --no-ri')
    shell('gem install mysql2 --no-rdoc --no-ri')

    opt = path('/opt').mkdir_p()

    install_ruby_repo(repo, opt / 'admin-ui', (templates / 'Gemfile.lock', ))

    install_ruby_repo('https://github.com/cloudfoundry/cf-uaac.git',
                      opt / 'uaac')


if __name__ == "__main__":
    install()
